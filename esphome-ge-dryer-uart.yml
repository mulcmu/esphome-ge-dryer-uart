substitutions:
  name: dryer
  upper_name: Dryer
  init: 'component_geUART::instance(id(uart_bus));'

esphome:
  name: dryer
  platform: esp32
  board: nodemcu-32s
  includes:
    - esphome-ge-dryer-uart.h
  
# Enable logging via web interface only
logger:
  baud_rate: 0

# Enable Home Assistant API
api:

ota:
  password: !secret esp_home_ota_pw

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Optional manual IP
  manual_ip:
    static_ip: 192.168.0.191
    gateway: 192.168.0.9
    subnet: 255.255.255.0

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: ${upper_name} Fallback Hotspot
    password: !secret esp_home_captive_pw

#captive_portal:

# Sync time with Home Assistant.
time:
  - platform: homeassistant
    id: homeassistant_time

uart:
  - id: uart_bus
    tx_pin: 
      number: GPIO18
      inverted: false
    rx_pin: 
      number: GPIO19
      inverted: false
    baud_rate: 230400
    debug:
      direction: BOTH
      after:
          timeout: 50ms
      sequence:
        - lambda:  UARTDebug::log_hex(direction, bytes, ' ');
        
custom_component:
  - lambda: |-
      auto c_ge_uart = ${init}
      return {c_ge_uart};


sensor:
  # Uptime sensor.
  - platform: uptime
    name: ${upper_name} Uptime

  # WiFi Signal sensor.
  - platform: wifi_signal
    name: ${upper_name} WiFi Signal
    update_interval: 60s
  - platform: custom
    lambda: |-
      auto c_ge_uart = ${init}
      return {
        c_ge_uart->sensor_remainingtime
      };
    sensors:
      - name: ${upper_name} Time Remaining
        unit_of_measurement: min
        accuracy_decimals: 1
        icon: mdi:progress-clock


# Text sensors with general information.
text_sensor:
  # Expose WiFi information as sensors.
  - platform: wifi_info
    ip_address:
      name: ${upper_name} IP
  - platform: custom
    lambda: |-
        auto c_ge_uart = ${init}
        return {
          c_ge_uart->textsensor_dryerState,
          c_ge_uart->textsensor_dryerCycle,
          c_ge_uart->textsensor_dryerSubState,
          c_ge_uart->textsensor_endOfCycle,
          c_ge_uart->textsensor_DrynessSetting,
          c_ge_uart->textsensor_HeatSetting,
          c_ge_uart->textsensor_SoilSetting, 
          c_ge_uart->textsensor_TempSetting, 
          c_ge_uart->textsensor_SpinSetting, 
          c_ge_uart->textsensor_RinseSetting
          };
          
          
    text_sensors:
        - name: ${upper_name} State
          icon: mdi:tumble-dryer
        - name: ${upper_name} Cycle
          icon: mdi:tumble-dryer
        - name: ${upper_name} SubState
          icon: mdi:tumble-dryer
        - name: ${upper_name} End of Cycle
          icon: mdi:alarm-check
        - name: ${upper_name} Dryness Setting
          icon: mdi:water-circle
        - name: ${upper_name} Heat Setting
          icon: mdi:progress-clock
        - name: ${upper_name} Soil Setting
          icon: mdi:progress-clock
        - name: ${upper_name} Temp Setting
          icon: mdi:progress-clock
        - name: ${upper_name} Spin Setting
          icon: mdi:progress-clock
        - name: ${upper_name} Rinse Setting
          icon: mdi:progress-clock          

#turn on blue led on at boot and back off when connected to wifi
output:
  - platform: gpio
    pin: GPIO2
    id: onboard_led
    inverted: True

interval:
  - interval: 1s
    then:
      if:
        condition:
          wifi.connected:
        then:
          - output.turn_on: onboard_led
        else:
          - output.turn_off: onboard_led
